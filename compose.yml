services:
  # network
  r0:
    image: frrouting/frr:latest
    privileged: true
    volumes:
      - ./r0:/etc/frr
    networks:
      sapporo:
      r0-r1:
        ipv4_address: 172.16.101.1
      r0-r2:
        ipv4_address: 172.16.102.1
      r0-r3:
        ipv4_address: 172.16.103.1
    command: ["bash", "-c", "sysctl -w net.ipv4.ip_forward=1 && /usr/lib/frr/frrinit.sh start && tail -f /dev/null"]
  r1:
    image: frrouting/frr:latest
    privileged: true
    volumes:
      - ./r1:/etc/frr
    networks:
      otaru:
        ipv4_address: 192.168.101.200
      r0-r1:
        ipv4_address: 172.16.101.200
    command: ["bash", "-c", "sysctl -w net.ipv4.ip_forward=1 && /usr/lib/frr/frrinit.sh start && tail -f /dev/null"]
  r2:
    image: frrouting/frr:latest
    privileged: true
    volumes:
      - ./r2:/etc/frr
    networks:
      asahikawa:
        ipv4_address: 192.168.102.200
      r0-r2:
        ipv4_address: 172.16.102.200
    command: ["bash", "-c", "sysctl -w net.ipv4.ip_forward=1 && /usr/lib/frr/frrinit.sh start && tail -f /dev/null"]
  r3:
    image: frrouting/frr:latest
    privileged: true
    volumes:
      - ./r3:/etc/frr
    networks:
      hakodate:
        ipv4_address: 192.168.103.200
      r0-r3:
        ipv4_address: 172.16.103.200
    command: ["bash", "-c", "sysctl -w net.ipv4.ip_forward=1 && /usr/lib/frr/frrinit.sh start && tail -f /dev/null"]
  # client
  client-otaru:
    build:
      context: ./client
    cap_add:
      - NET_ADMIN
    networks:
      otaru:
        ipv4_address: 192.168.101.1
    command: ["bash", "-c", "ip route add default via 192.168.101.200 && sleep infinity"]
    
  client-hakodate:
    build:
      context: ./client
    cap_add:
      - NET_ADMIN
    networks:
      hakodate:
        ipv4_address: 192.168.103.1
    command: ["bash", "-c", "ip route add default via 192.168.103.200 && sleep infinity"]

  web:
    build:
      context: ./web
    cap_add:
      - NET_ADMIN
    networks:
      sapporo:
        ipv4_address: 192.168.100.102
    command: ["bash", "-c", "ip route add default via 192.168.100.200 && nginx -g 'daemon off;' "]

networks:
  sapporo:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 192.168.100.0/24
          gateway: 192.168.100.250
  otaru:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 192.168.101.0/24
          gateway: 192.168.101.250
  asahikawa:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 192.168.102.0/24
          gateway: 192.168.102.250
  hakodate:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 192.168.103.0/24
          gateway: 192.168.103.250
  r0-r1:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.16.101.0/24
          gateway: 172.16.101.250
  r0-r2:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.16.102.0/24
          gateway: 172.16.102.250
  r0-r3:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.16.103.0/24
          gateway: 172.16.103.250
